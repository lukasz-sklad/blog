---
title: 'Sieciowa Odyseja: Jak ZÅ‚amaÅ‚em Mur MiÄ™dzy Linuksem a SambÄ… na macOS VM ğŸ¤¯'
description: 'MyÅ›lisz, Å¼e routing miÄ™dzy VM a hostem to buÅ‚ka z masÅ‚em? Ta historia pokaÅ¼e Ci, jak niewinna proÅ›ba o dostÄ™p do Samby zamieniÅ‚a siÄ™ w epickÄ… bitwÄ™ z firewallem pf na macOS, by udostÄ™pniÄ‡ zasoby Linuksowi.'
summary: 'macos samba vmware pf routing nat debian linux openwrt'
date: WrzesieÅ„ September 20 2025
slug: sieciowa-odyseja-macos-linux-samba-pf
---

# Sieciowa Odyseja: Jak ZÅ‚amaÅ‚em Mur MiÄ™dzy Linuksem a SambÄ… na macOS VM ğŸ¤¯

InÅ¼ynieria to nie tylko pisanie kodu. To sztuka rozwiÄ…zywania problemÃ³w, upÃ³r w obliczu poraÅ¼ki i ta czysta, niepodrabialna radoÅ›Ä‡, gdy po wielu godzinach walki wreszcie coÅ›... po prostu dziaÅ‚a. âœ¨ To jest historia jednej takiej walki. Odysei, w ktÃ³rÄ… wyruszyÅ‚em, by poÅ‚Ä…czyÄ‡ trzy Å›wiaty: hosta macOS, wirtualnÄ… maszynÄ™ z Debianem i klienta z Linuksem.

## Prolog: Niewinna ProÅ›ba

Wszystko zaczÄ™Å‚o siÄ™ od Å›wietnego poradnika [Samba na Debianie](https://lmk.one/posts/2025-09-19-samba-na-debianie). UÅ¼ytkownik starannie odtworzyÅ‚ konfiguracjÄ™ na swojej wirtualnej maszynie postawionej na macOS. StanÄ…Å‚ jednak przed murem â€“ udziaÅ‚ Samby byÅ‚ idealnie widoczny na hoÅ›cie (macOS), ale kompletnie niewidzialny dla drugiego komputera w sieci z Linuksem. To byÅ‚a zagadka, ktÃ³ra daÅ‚a poczÄ…tek naszej przygodzie.


## RozdziaÅ‚ I: Budujemy Plan (i Pierwsze Mury)

GÅ‚Ã³wny cel: uzyskaÄ‡ dostÄ™p do udziaÅ‚u Samby na wirtualnej maszynie (`172.17.156.146`) z komputera z Linuksem (`192.168.1.4`) w tej samej sieci, w ktÃ³rej byÅ‚ Mac-host (`192.168.1.3`).

Pierwszy, logiczny plan zakÅ‚adaÅ‚ dwa kroki:

1.  **Na routerze (potÄ™Å¼nym OpenWrt):** Dodamy trasÄ™ statycznÄ…. Trzeba byÅ‚o powiedzieÄ‡ routerowi: "Drogi routerze, jeÅ›li ktokolwiek w sieci zapyta o drogÄ™ do `172.17.156.0/24`, wskaÅ¼ mu Maca pod adresem `192.168.1.3` jako bramÄ™". Bez tego pakiety z Linuksa nigdy by nie wiedziaÅ‚y, gdzie szukaÄ‡ tej odlegÅ‚ej podsieci.

2.  **Na komputerze-hoÅ›cie (macOS):** MiaÅ‚ on staÄ‡ siÄ™ przewodnikiem dla zagubionych pakietÃ³w, czyli routerem.

Niestety, zanim na dobre zaczÄ™liÅ›my, pojawiÅ‚y siÄ™ komplikacje - najpierw blokada SSH przez `/etc/hosts.deny`, a potem... zrozumienie, Å¼e w grze jest jeszcze jeden, ukryty gracz.

> "...bo tam jest **cloudflare tunel** dla nexclouda..."

ZamarÅ‚em. ğŸ˜± To oznaczaÅ‚o, Å¼e proste trasowanie nie wystarczy. MusieliÅ›my siÄ™gnÄ…Ä‡ po ciÄ™Å¼sze dziaÅ‚a.

## RozdziaÅ‚ II: Droga Wojownika - Zmuszamy Maca, by zostaÅ‚ Routerem

Zamiast prostej drogi (tryb mostka w VM), wybraliÅ›my Å›cieÅ¼kÄ™ wiedzy: zmusimy macOS, by staÅ‚ siÄ™ peÅ‚noprawnym routerem NAT dla naszej sieci. NaszÄ… broniÄ… staÅ‚ siÄ™ `pf` (Packet Filter), potÄ™Å¼na zapora sieciowa wbudowana w macOS.

### Krok 1: WÅ‚Ä…czenie Przekazywania PakietÃ³w (IP Forwarding)

Zanim `pf` zacznie swojÄ… magiÄ™, system macOS musi w ogÃ³le zgodziÄ‡ siÄ™ na przekazywanie pakietÃ³w miÄ™dzy interfejsami sieciowymi. Bez tego jest jak zamkniÄ™ty szlaban. Aby go otworzyÄ‡ na staÅ‚e, wykonaliÅ›my polecenie:

```bash
# Uczynienie zmiany trwaÅ‚Ä… po restarcie
echo "net.inet.ip.forwarding=1" | sudo tee -a /etc/sysctl.conf

# Aktywacja "od zaraz" bez restartu
sudo sysctl -w net.inet.ip.forwarding=1
```

Teraz nasz Mac byÅ‚ gotÃ³w, by staÄ‡ siÄ™ przewodnikiem.

### Krok 2: Taniec z `pf` - Magia Maskarady

NastÄ™pnie stworzyliÅ›my reguÅ‚Ä™ dla `pf`, ktÃ³ra miaÅ‚a "maskowaÄ‡" pakiety z Linuksa, tak aby wirtualna maszyna myÅ›laÅ‚a, Å¼e rozmawia tylko ze swoim hostem (macOS).

```bash
# Plik /tmp/pf.rules - nasza magiczna rÃ³Å¼dÅ¼ka
nat on bridge102 from 192.168.1.0/24 to 172.17.156.0/24 -> (bridge102)
```

ZaÅ‚adowaliÅ›my jÄ… do `pf`...

```bash
sudo pfctl -E
sudo pfctl -f /tmp/pf.rules
```

...i wtedy nadszedÅ‚ moment prawdy. `ping` z komputera z Linuksem.

```
PING cloud.lmk.one (172.17.156.146) 56(84) bytes of data.
64 bytes from cloud.lmk.one (172.17.156.146): icmp_seq=1 ttl=63 time=2.25 ms
...
--- cloud.lmk.one ping statistics ---
4 packets transmitted, 4 received, 0% packet loss...
```

**ZwyciÄ™stwo!** ğŸ‰ Czyste, techniczne zwyciÄ™stwo.

## RozdziaÅ‚ III: Ostatnia Bitwa - NieÅ›miertelnoÅ›Ä‡ Konfiguracji

RadoÅ›Ä‡ byÅ‚a wielka, ale krÃ³tka. Konfiguracja `pf` i `sysctl` byÅ‚a ulotna. MusieliÅ›my uczyniÄ‡ jÄ… nieÅ›miertelnÄ…. RozwiÄ…zaniem okazaÅ‚ siÄ™ sprytny skrypt startowy i odpowiednie uprawnienia.

1.  **Inteligentny skrypt**, ktÃ³ry cierpliwie czeka na start VM i konfiguruje wszystko za jednym zamachem:

    ```bash
    #!/bin/bash
    # WÅ‚Ä…czamy forwarding
    sudo sysctl -w net.inet.ip.forwarding=1

    # Czekamy na interfejs VM
    VIRTUAL_INTERFACE="bridge102"
    echo "Czekam na interfejs ${VIRTUAL_INTERFACE}..."
    while ! ifconfig | grep -q "^${VIRTUAL_INTERFACE}:"; do
        sleep 10
    done

    # Konfigurujemy PF
    echo "OK. KonfigurujÄ™ pf..."
    PF_RULES_FILE="/tmp/pf.rules.vm"
    echo "nat on ${VIRTUAL_INTERFACE} from 192.168.1.0/24 to 172.17.156.0/24 -> (${VIRTUAL_INTERFACE})" > "${PF_RULES_FILE}"
    sudo pfctl -E
    sudo pfctl -f "${PF_RULES_FILE}"
    echo "Gotowe! Magia siÄ™ dokonaÅ‚a. âœ¨"
    ```

2.  **Precyzyjna reguÅ‚a w `sudoers`** (pamiÄ™taj o `sudo visudo`!):

    ```
    # W pliku /etc/sudoers (edytowanym przez sudo visudo)
    NAZWA_UÅ»YTKOWNIKA   ALL=(ALL) NOPASSWD: /Users/NAZWA_UÅ»YTKOWNIKA/bin/start_maskarada.sh
    ```

3.  **Aplikacja w Automatorze**, ktÃ³ra uruchamiaÅ‚a nasz skrypt przy starcie systemu.



Aplikacje => Automator => Aplikacje => Uruchom skrypt powÅ‚oki wklejamy 

```
sudo /Users/NAZWA_UÅ»YTKOWNIKA/bin/start_maskarada.sh
```

* nie przejmujemy siÄ™ wborem PowÅ‚oki nie jest interpretowana w tym przypadku. Zachowaj jako start_maskarada.app i zapisujemy do naszych Aplikacji. Teraz dodajemy naszÄ… applikacjÄ™ Å¼eby siÄ™ uruchomiÅ‚a po zalogowaniu. Ustawienia systemowe => Rzeczy i rozszerzenia otwierane podczas logowania => + dodajemy naszÄ… aplikacjÄ™.

I to byÅ‚ koniec. Ostateczne, zautomatyzowane, piÄ™kne zwyciÄ™stwo.

## Epilog

Ta podrÃ³Å¼ nauczyÅ‚a mnie, Å¼e najprostsza droga nie zawsze jest tÄ…, ktÃ³rÄ… wybieramy. Czasem wybieramy drogÄ™ trudniejszÄ…, bo to na niej uczymy siÄ™ najwiÄ™cej. I nie ma nic bardziej satysfakcjonujÄ…cego niÅ¼ rozwikÅ‚anie sieciowego labiryntu.

<button onClick={() => alert("DziÄ™ki za wspÃ³lnÄ… podrÃ³Å¼! ğŸš€")}>
  Ta przygoda to dowÃ³d, Å¼e z odrobinÄ… uporu (i magii `pf`) wszystko jest moÅ¼liwe. Do zobaczenia w nastÄ™pnym wpisie! ğŸ§™â€â™‚ï¸ğŸŒŸ
</button>